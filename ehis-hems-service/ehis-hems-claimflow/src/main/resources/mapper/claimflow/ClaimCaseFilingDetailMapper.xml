<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.ehis.claimflow.mapper.ClaimCaseFilingDetailMapper">
    
    <resultMap type="com.paic.ehis.claimflow.domain.ClaimCaseFilingDetail" id="ClaimCaseFilingDetailResult">
        <result property="filingDetailId"    column="filing_detail_id"    />
        <result property="caseBoxNo"    column="case_box_no"    />
        <result property="batchNo"    column="batch_no"    />
        <result property="rptNo"    column="rpt_no"    />
        <result property="isFiling"    column="is_filing"    />
        <result property="isInvoiceBack"    column="is_invoice_back"    />
        <result property="isSingle"    column="is_single"    />
        <result property="status"    column="status"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="deptCode"    column="dept_code"    />
        <result property="remark"    column="remark"    />
        <result property="claimType"    column="claim_type"    />
    </resultMap>

    <sql id="selectClaimCaseFilingDetailVo">
        SELECT
            filing_detail_id,
            case_box_no,
            batch_no,
            rpt_no,
            is_filing,
            is_invoice_back,
            is_single,
            STATUS,
            create_by,
            create_time,
            update_by,
            update_time,
            dept_code,
            remark,
            ifnull(claim_type,(select claim_type from claim_batch WHERE STATUS = 'Y' and batch_no = (select t.batch_no  from claim_case t where t.status = 'Y' and t.rpt_no = t1.rpt_no))) claim_type
        FROM
            claim_case_filing_detail t1
</sql>

    <select id="selectClaimCaseFilingDetailList" parameterType="ClaimCaseFilingDetail" resultMap="ClaimCaseFilingDetailResult">
        <include refid="selectClaimCaseFilingDetailVo"/>
        <where>  
            <if test="caseBoxNo != null  and caseBoxNo != ''"> and case_box_no = #{caseBoxNo}</if>
            <if test="batchNo != null  and batchNo != ''"> and batch_no = #{batchNo}</if>
            <if test="rptNo != null  and rptNo != ''"> and rpt_no = #{rptNo}</if>
            <if test="isFiling != null  and isFiling != ''"> and is_filing = #{isFiling}</if>
            <if test="isInvoiceBack != null  and isInvoiceBack != ''"> and is_invoice_back = #{isInvoiceBack}</if>
            <if test="isSingle != null  and isSingle != ''"> and is_single = #{isSingle}</if>
            <if test="status != null  and status != ''"> and status = #{status}</if>
        </where>
    </select>
    
    <select id="selectClaimCaseFilingDetailById" parameterType="Long" resultMap="ClaimCaseFilingDetailResult">
        <include refid="selectClaimCaseFilingDetailVo"/>
        where filing_detail_id = #{filingDetailId}
    </select>

    <insert id="insertClaimCaseFilingDetailByRpt" parameterType="com.paic.ehis.claimflow.domain.ClaimCaseFiling">

        INSERT INTO
            claim_case_filing_detail (
                                        case_box_no,
                                        batch_no,
                                        rpt_no,
                                        status,
                                        create_by,
                                        create_time,
                                        update_by,
                                        update_time,
                                        dept_code,
                                        claim_type
                                    ) (
                                        select
                                           #{caseBoxNo},
                                           #{batchNo},
                                           rpt_no,
                                           'Y' ,
                                           #{createBy},
                                           now(),
                                           #{createBy},
                                           now(),
                                           #{deptCode},
                                           #{claimType}
                                        from claim_case t
                                        where substr(t.rpt_no,1,7) = substr(#{rptStartNo},1,7)
                                <![CDATA[ and  substr(t.rpt_no,8) >= substr(#{rptStartNo},8) ]]>
                                <![CDATA[ and substr(t.rpt_no,8) <= substr(#{rptEndNo},8) ]]>
                                <if test="batchNo != null  and batchNo != ''"> and t.batch_no = #{batchNo}</if>
        )
    </insert>

    <insert id="insertClaimCaseFilingDetail" parameterType="ClaimCaseFilingDetail" useGeneratedKeys="true" keyProperty="filingDetailId">
        insert into claim_case_filing_detail
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="caseBoxNo != null and caseBoxNo != ''">case_box_no,</if>
            <if test="batchNo != null and batchNo != ''">batch_no,</if>
            <if test="rptNo != null and rptNo != ''">rpt_no,</if>
            <if test="isFiling != null">is_filing,</if>
            <if test="isInvoiceBack != null">is_invoice_back,</if>
            <if test="isSingle != null">is_single,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="createBy != null and createBy != ''">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="caseBoxNo != null and caseBoxNo != ''">#{caseBoxNo},</if>
            <if test="batchNo != null and batchNo != ''">#{batchNo},</if>
            <if test="rptNo != null and rptNo != ''">#{rptNo},</if>
            <if test="isFiling != null">#{isFiling},</if>
            <if test="isInvoiceBack != null">#{isInvoiceBack},</if>
            <if test="isSingle != null">#{isSingle},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="createBy != null and createBy != ''">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
         </trim>
    </insert>

    <update id="updateClaimCaseFilingDetail" parameterType="ClaimCaseFilingDetail">
        update claim_case_filing_detail
        <trim prefix="SET" suffixOverrides=",">
            <if test="caseBoxNo != null and caseBoxNo != ''">case_box_no = #{caseBoxNo},</if>
            <if test="batchNo != null and batchNo != ''">batch_no = #{batchNo},</if>
            <if test="rptNo != null and rptNo != ''">rpt_no = #{rptNo},</if>
            <if test="isFiling != null">is_filing = #{isFiling},</if>
            <if test="isInvoiceBack != null">is_invoice_back = #{isInvoiceBack},</if>
            <if test="isSingle != null">is_single = #{isSingle},</if>
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="createBy != null and createBy != ''">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
            <if test="claimType != null and claimType != ''"> claim_type = #{claimType},</if>
        </trim>
        where 1 = 1  and status = 'Y'
        <if test="filingDetailId != null"> and filing_detail_id = #{filingDetailId}</if>
        <if test="caseBoxNo != null and caseBoxNo != ''"> and case_box_no = #{caseBoxNo}</if>
    </update>

    <delete id="deleteClaimCaseFilingDetailById" parameterType="Long">
        delete from claim_case_filing_detail where filing_detail_id = #{filingDetailId}
    </delete>

    <delete id="deleteClaimCaseFilingDetailByIds" parameterType="String">
        delete from claim_case_filing_detail where filing_detail_id in 
        <foreach item="filingDetailId" collection="array" open="(" separator="," close=")">
            #{filingDetailId}
        </foreach>
    </delete>

    <delete id="deleteClaimCaseFilingDetailByCaseBoxNo" parameterType="String">
        UPDATE claim_case_filing_detail set status = 'N' WHERE case_box_no = #{caseBoxNo}
    </delete>
</mapper>