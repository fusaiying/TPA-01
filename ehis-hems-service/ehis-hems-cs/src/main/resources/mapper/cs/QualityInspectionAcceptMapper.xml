<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.ehis.cs.mapper.QualityInspectionAcceptMapper">
    <!-- 工作池返回对象 -->
    <resultMap type="com.paic.ehis.cs.domain.vo.AcceptVo" id="AcceptResult">
        <result property="workOrderNo" column="work_order_no"/>
        <result property="businessType" column="business_type"/>
        <result property="serviceItem" column="item_code"/>
        <result property="businessService" column="business_service"/>
        <result property="channel" column="channel_code"/>
        <result property="policyNo" column="policy_no"/>
        <result property="policyItemNo" column="policy_item_no"/>
        <result property="riskCode" column="risk_code"/>
        <result property="acceptTime" column="create_time"/>
        <result property="modifyTime" column="modify_time"/>
        <result property="vipFlag" column="vip_flag"/>
        <result property="priorityLevel" column="priority_level"/>
        <result property="organCode" column="organ_code"/>
        <result property="endDate" column="end_date"/>
        <result property="status" column="status"/>

    </resultMap>

    <sql id="selectAcceptVo">
        select woa.work_order_no,woa.business_type,adi.item_code,concat(woa.business_type,'-', adi.item_code) as business_service,adi.channel_code,
            woa.policy_no,woa.policy_item_no,woa.end_date,qia.status
        from quality_inspection_accept qia
            left join  work_order_accept woa on qia.work_order_no=woa.work_order_no
            left join accept_detail_info adi on woa.work_order_no = adi.work_order_no
    </sql>

    <sql id="selectSendVo">
        select woa.work_order_no,woa.business_type,adi.channel_code,adi.item_code,concat(woa.business_type,'-', adi.item_code) as business_service,
            woa.policy_no,woa.policy_item_no,woa.risk_code,woa.create_time,woa.modify_time,woa.organ_code,woa.vip_flag,adi.priority_level,woa.status
        from work_order_accept woa
            left join accept_detail_info adi on woa.work_order_no = adi.work_order_no
    </sql>

    <select id="selectSendByVo" parameterType="com.paic.ehis.cs.domain.dto.WorkOrderQueryDTO" resultMap="AcceptResult">
        <include refid="selectSendVo"/>
        where 1=1 and not exists (SELECT 1 FROM quality_inspection_accept qia WHERE qia.work_order_no=woa.work_order_no)
        <if test="endCaseStartTime != null ">
            and DATE_FORMAT(woa.end_date,'%Y-%m-%d') <![CDATA[>=]]> #{endCaseStartTime}
        </if>

        <if test="endCaseEndTime != null ">
            and DATE_FORMAT(woa.end_date,'%Y-%m-%d') <![CDATA[<=]]> #{endCaseEndTime}
        </if>

        <if test="organCode != null  and organCode != ''"> and woa.organ_code = #{organCode}</if>

        <if test="acceptStatus != null  and acceptStatus != ''"> and woa.status = #{acceptStatus}</if>

        <if test="serviceItem != null  and serviceItem != ''"> and adi.item_code = #{serviceItem}</if>
    </select>

    <select id="selectAcceptByVo" parameterType="com.paic.ehis.cs.domain.dto.WorkOrderQueryDTO" resultMap="AcceptResult">
        <include refid="selectAcceptVo"/>
        where 1=1

        <if test="endCaseStartTime != null ">
            and DATE_FORMAT(woa.end_date,'%Y-%m-%d') <![CDATA[>=]]> #{endCaseStartTime}
        </if>

        <if test="endCaseEndTime != null ">
            and DATE_FORMAT(woa.end_date,'%Y-%m-%d') <![CDATA[<=]]> #{endCaseEndTime}
        </if>

        <if test="organCode != null and organCode != ''"> and woa.organ_code = #{organCode}</if>

        <if test="acceptStatus != null and acceptStatus != ''"> and qia.status = #{acceptStatus}</if>

        <if test="serviceItem != null and serviceItem != ''"> and adi.item_code = #{serviceItem}</if>

        <if test="updateBy !=null and updateBy !='' "> and qia.updated_by = #{updateBy}</if>

    </select>
<!--    批量插入数据-->
    <insert id="insertAcceptBatch" parameterType="java.util.List">
        INSERT INTO quality_inspection_accept
        (work_order_no, `result`, status, created_by, created_time, updated_by, updated_time)
        VALUES
        <foreach collection="list" item="qualityInspectionAccept" index="index" separator=",">
            (
            #{qualityInspectionAccept.workOrderNo},
            #{qualityInspectionAccept.result},
            #{qualityInspectionAccept.status},
            #{qualityInspectionAccept.createdBy},
            #{qualityInspectionAccept.createdTime},
            #{qualityInspectionAccept.updatedBy},
            #{qualityInspectionAccept.updatedTime}
            )
        </foreach>
    </insert>

    <!-- 批量发送质检-->
    <update id="updateAcceptByVoDTO"
            parameterType="com.paic.ehis.cs.domain.dto.WorkOrderQueryDTO">
        UPDATE quality_inspection_accept
        SET
        status = #{acceptStatus},
        updated_by = #{updateBy},
        updated_time = #{updateTime}
        WHERE
        work_order_no IN (
        <foreach collection="workOrderNoList" item="workOrderNo"
                 separator=",">
            #{workOrderNo}
        </foreach>
        )
    </update>
</mapper>