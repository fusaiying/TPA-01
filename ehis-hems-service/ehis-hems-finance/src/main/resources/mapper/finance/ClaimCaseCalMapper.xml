<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.ehis.finance.mapper.ClaimCaseCalMapper">
    
    <resultMap type="com.paic.ehis.finance.domain.ClaimCaseCal" id="ClaimCaseCalResult">
        <result property="calId"    column="cal_id"    />
        <result property="rptNo"    column="rpt_no"    />
        <result property="billCurrency"    column="bill_currency"    />
        <result property="calAmount"    column="cal_amount"    />
        <result property="payAmount"    column="pay_amount"    />
        <result property="refusedAmount"    column="refused_amount"    />
        <result property="debtAmount"    column="debt_amount"    />
        <result property="exchangeRate"    column="exchange_rate"    />
        <result property="payAmountForeign"    column="pay_amount_foreign"    />
        <result property="payConclusion"    column="pay_conclusion"    />
        <result property="refusedReason"    column="refused_reason"    />
        <result property="remark"    column="remark"    />
        <result property="claimCheck"    column="claim_check"    />
        <result property="status"    column="status"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectClaimCaseCalVo">
        select cal_id, rpt_no, bill_currency, cal_amount, pay_amount, refused_amount, debt_amount, exchange_rate, pay_amount_foreign, pay_conclusion, refused_reason, remark, claim_check, status, create_by, create_time, update_by, update_time from claim_case_cal
    </sql>


    <select id="selectClaimCaseCalByRptNo" parameterType="String" resultMap="ClaimCaseCalResult">
        <include refid="selectClaimCaseCalVo"/>
        where
            status = 'Y'
            <if test="rptNo != null  and rptNo != ''"> and rpt_no = #{rptNo}</if>
    </select>

    <select id="selectClaimCaseCalAmountByBatchNo" parameterType="String" resultType="com.paic.ehis.finance.domain.vo.ClaimCasePaymentVO">
       SELECT IFNULL(SUM(c.cal_amount),0) calAmount from (SELECT IFNULL(SUM(ccc.cal_amount),0) cal_amount FROM claim_case cc LEFT JOIN claim_case_cal ccc on cc.rpt_no=ccc.rpt_no and ccc.status='Y' where cc.batch_no= #{batchNo} and not EXISTS (SELECT 1 FROM claim_case_appeal_task cat where cc.rpt_no=cat.appeal_rpt_no and cat.appeal_status='03' AND cat.STATUS='Y' )
        and cc.status='Y' and cc.case_prop='01' and cc.case_status not in ('97','98')
        union all
        select  cast(IFNULL(sum(d.cal_amount),0) as decimal(16,2)) cal_amount from claim_case cc LEFT JOIN (SELECT rpt_no,SUBSTRING_INDEX(GROUP_CONCAT(t.cal_amount ORDER BY t.appeal_serial DESC ),',',1) cal_amount
FROM claim_case_cal_core t  where t.status='Y' GROUP BY rpt_no) d on d.rpt_no=cc.rpt_no  where cc.STATUS='Y' AND cc.case_prop='02' AND cc.batch_no=#{batchNo} and cc.case_status not in ('97','98')) c
    </select>

</mapper>