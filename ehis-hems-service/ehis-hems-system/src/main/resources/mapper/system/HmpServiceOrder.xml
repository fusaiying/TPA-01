<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.paic.ehis.system.mapper.HmpServiceOrderMapper">

    <resultMap id="hmpservicemap" type="HmpServiceOrder">
        <result property="ordercode" column="ordercode"/>
        <result property="ordersource" column="ordersource"/>
        <result property="productcode" column="productcode"/>
        <result property="servicecode" column="servicecode"/>
        <result property="appointmenttime" column="appointmenttime"/>
        <result property="supplier" column="supplier"/>
        <result property="supplieroutlets" column="supplieroutlets"/>
        <result property="supplierdoctor" column="supplierdoctor"/>
        <result property="orderstatus" column="orderstatus"/>
        <result property="createby" column="create_by"/>
        <result property="createtime" column="create_time"/>
        <result property="updateby" column="update_by"/>
        <result property="updatetime" column="update_time"/>

        <association property="serviceOrderApplication" javaType="HmpServiceOrderApplication" resultMap="serviceorderappmap"></association>
    </resultMap>

    <resultMap id="serviceorderappmap" type="HmpServiceOrderApplication">
        <result property="ordercode" column="ordercode"/>
        <result property="applicationcode" column="applicationcode"/>
        <result property="user" column="user"/>
        <result property="useridtype" column="useridtype"/>
        <result property="useridcode" column="useridcode"/>
        <result property="usersex" column="usersex"/>
        <result property="userbirthday" column="userbirthday"/>
        <result property="usermobile" column="usermobile"/>
        <result property="contacts" column="contacts"/>
        <result property="contactsidtype" column="contactsidtype"/>
        <result property="contactsidcode" column="contactsidcode"/>
        <result property="contactsmobile" column="contactsmobile"/>
        <result property="status" column="status"/>
        <result property="createby" column="create_by"/>
        <result property="createtime" column="create_time"/>
        <result property="updateby" column="update_by"/>
        <result property="updatetime" column="update_time"/>
    </resultMap>

    <resultMap id="HmpOrderUserMap" type="HmpOrderUser">
        <result property="serialnum" column="serialnum"/>
        <result property="ordercode" column="ordercode"/>
        <result property="userId" column="user_id"/>
        <result property="status" column="status"/>
        <result property="operator" column="operator"/>
        <result property="makedate" column="makedate"/>
        <result property="maketime" column="maketime"/>
        <result property="modifyoperator" column="modifyoperator"/>
        <result property="modifydate" column="modifydate"/>
        <result property="modifytime" column="modifytime"/>
    </resultMap>

    <select id="selectServiceOrderList" parameterType="HmpServiceOrder" resultMap="hmpservicemap">
        SELECT b.ordercode,a.user,
            (select dict_label from sys_dict_data where dict_type = 'sys_user_sex' and dict_value = a.usersex) usersex,
            (select dict_label from sys_dict_data where dict_type = 'id_type' and dict_value = a.useridtype) useridtype,
            a.useridcode,a.usermobile, d.productname as PRODUCTCODE,
            (select distinct projectname from hmp_serv_project where projectcode = b.servicecode) servicecode,
            (select chname from hmp_serv_opera where servcomno = b.supplier) supplier,
            b.supplieroutlets,b.appointmenttime
        FROM
            hmp_service_order b left join hmp_service_order_application a on a.ordercode=b.ordercode
            left join hmp_prod_info d on d.productno = b.productcode
            left join hmp_serv_project e on e.projectcode = b.servicecode and e.nodecode = 'fenzhen'
        WHERE
        not exists (select 1 from hmp_order_user c where b.ordercode = c.ordercode and c.status='01')
        <if test="serviceOrderApplication.user != null and serviceOrderApplication.user != ''"> and a.user like concat('%', #{serviceOrderApplication.user}, '%') </if>
        <if test="serviceOrderApplication.usersex != null and serviceOrderApplication.usersex != ''"> and a.usersex = #{serviceOrderApplication.usersex} </if>
        <if test="serviceOrderApplication.useridtype != null and serviceOrderApplication.useridtype != ''"> and a.useridtype = #{serviceOrderApplication.useridtype} </if>
        <if test="serviceOrderApplication.useridcode != null and serviceOrderApplication.useridcode != ''"> and a.useridcode = #{serviceOrderApplication.useridcode} </if>
        <if test="serviceOrderApplication.usermobile != null and serviceOrderApplication.usermobile != ''"> and a.usermobile = #{serviceOrderApplication.usermobile} </if>
        <if test="servicecode != null and servicecode != ''"> and e.projectname like concat('%', #{servicecode}, '%')  </if>
        <if test="productcode != null and productcode != ''"> and d.productname like concat('%', #{productcode}, '%') </if>
        <if test="ordersource != null and ordersource != ''"> and b.ordersource = #{ordersource} </if>
        <if test="params.beginTime != null and params.endTime != null"> and b.appointmenttime between #{params.beginTime} and #{params.endTime} </if>
    </select>

    <select id="selectServiceOrderListByOnwer" parameterType="SysUser" resultMap="hmpservicemap">
        SELECT a.ordercode,
            (select distinct projectname from hmp_serv_project where projectcode = a.servicecode) servicecode,
            (select chname from hmp_serv_opera where servcomno = a.supplier) supplier,
            (select productname from hmp_prod_info where productcode = a.productcode) productcode,
            a.appointmenttime,
            (select dict_label from sys_dict_data where dict_type = 'order_status' and dict_value = a.orderstatus) orderstatus,
            b.user,
            (select dict_label from sys_dict_data where dict_type = 'sys_user_sex' and dict_value = b.usersex) usersex,
          (select dict_label from sys_dict_data where dict_type = 'id_type' and dict_value = b.useridtype) useridtype,
            b.useridcode,b.usermobile
        FROM
            hmp_service_order a,
            hmp_service_order_application b,
            hmp_order_user c,
            sys_user d
        WHERE
            a.ordercode = b.ordercode
            AND a.ordercode = c.ordercode
            AND c.user_id = d.user_id
            AND c.status = '01'
            AND d.user_name = #{userName}
    </select>

    <select id="getOwnerIdByName" parameterType="String" resultType="String">
        select user_id from sys_user where user_name = #{ownerName}
    </select>

    <update id="updateHmpOrderUser" parameterType="HmpOrderUser" >
        update hmp_order_user
        <trim prefix="SET" suffixOverrides=",">
            <if test="status != null and status != ''">status = #{status},</if>
            <if test="modifyoperator != null and modifyoperator != ''">modifyoperator = #{modifyoperator},</if>
            <if test="modifytime != null and modifytime != ''">modifytime = #{modifytime},</if>
            <if test="modifydate != null">modifydate = #{modifydate},</if>
        </trim>
        where ordercode = #{ordercode}
        and status = '01'
    </update>

    <insert id="insertHmpOrderUser" parameterType="HmpOrderUser" useGeneratedKeys="true" keyProperty="serialnum">
        insert into hmp_order_user
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="serialnum != null and serialnum != ''">serialnum,</if>
            <if test="ordercode != null and ordercode != ''">ordercode,</if>
            <if test="userId != null and userId != ''">user_id,</if>
            <if test="status != null and status != ''">status,</if>
            <if test="operator != null and operator != ''">operator,</if>
            <if test="makedate != null">makedate,</if>
            <if test="maketime != null and serialnum != ''">maketime,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="serialnum != null and serialnum != ''">#{serialnum},</if>
            <if test="ordercode != null and ordercode != ''">#{ordercode},</if>
            <if test="userId != null and userId != ''">#{userId},</if>
            <if test="status != null and status != ''">#{status},</if>
            <if test="operator != null and operator != ''">#{operator},</if>
            <if test="makedate != null">#{makedate},</if>
            <if test="maketime != null and serialnum != ''">#{maketime},</if>
        </trim>
    </insert>

    <select id="getServiceOrderByOrderCode" parameterType="String" resultType="HmpServiceOrder">
        SELECT
            a.appointmenttime,
            (select dict_label from sys_dict_data where dict_type = 'service_ordersource' and dict_value = a.ordersource) ordersource,
            (select dict_label from sys_dict_data where dict_type = 'order_status' and dict_value = a.orderstatus) orderstatus,
            (select productname from hmp_prod_info where productno = a.productcode) productcode,
            (select distinct projectname from hmp_serv_project where projectcode = a.servicecode) servicecode,
            (select chname from hmp_serv_opera where servcomno = a.supplier) supplier,
            a.create_by,a.create_time,a.supplierdoctor,a.supplieroutlets,a.update_by,a.update_time
        FROM
            hmp_service_order a
        WHERE
            a.ordercode = #{ordercode}
    </select>

    <select id="getServicePersonByOrderCode" resultType="HmpServiceOrderApplication">
        SELECT
            b.user,b.userbirthday,
            (select dict_label from sys_dict_data where dict_type = 'sys_user_sex' and dict_value = b.usersex) usersex,
            (select dict_label from sys_dict_data where dict_type = 'id_type' and dict_value = b.useridtype) useridtype,
            b.useridcode,b.usermobile,
            b.applicationcode,b.contacts,b.contactsidcode,b.contactsidtype,b.contactsmobile,
            b.create_by,b.create_time,b.status,b.update_by,b.update_time
        FROM
            hmp_service_order_application b
        WHERE
            b.ordercode = #{ordercode}
    </select>

    <select id="selectOrderUser" parameterType="HmpOrderUser" resultMap="HmpOrderUserMap">
        SELECT
            *
        FROM
            hmp_order_user a
        WHERE
            a.ordercode = #{ordercode}
        <if test="status != null and status != ''"> and a.status = #{status} </if>
    </select>
</mapper>